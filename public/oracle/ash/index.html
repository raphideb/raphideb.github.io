<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta name="google-site-verification" content="yIs8HxNKHFWzdJCQOYw1Gb4UqF2Lefe13WszIZGnE_c" />

  </head>
  <body class="td-page">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg width="60" height="0" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="monospace" font-size="64" font-type="bold" fill="#fff">ok#</text></svg></span><span class="navbar-brand__name">crashdump</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://www.postgresql.org/docs/" target="_blank" rel="noopener"><span>Postgres documentation</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://docs.oracle.com/en/database/oracle/oracle-database/index.html" target="_blank" rel="noopener"><span>Oracle documentation</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://www.perplexity.ai/" target="_blank" rel="noopener"><span>Perplexity</span></a>
      </li>
      <li class="td-light-dark-menu nav-item dropdown">
        <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="check2" viewBox="0 0 16 16">
    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
  </symbol>
  <symbol id="circle-half" viewBox="0 0 16 16">
    <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
  </symbol>
  <symbol id="moon-stars-fill" viewBox="0 0 16 16">
    <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
    <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/>
  </symbol>
  <symbol id="sun-fill" viewBox="0 0 16 16">
    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
  </symbol>
</svg>

<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center"
        id="bd-theme"
        type="button"
        aria-expanded="false"
        data-bs-toggle="dropdown"
        data-bs-display="static"
        aria-label="Toggle theme (auto)">
  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg>
</button>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#sun-fill"></use></svg>
      Light
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"></use></svg>
      Dark
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
      <svg class="bi me-2 opacity-50"><use href="#circle-half"></use></svg>
      Auto
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
</ul>

      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m--li">
  <a href="/" title="Hi there!" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-"><span class="">Home</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-postgres-li">
  <a href="/postgres/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-postgres"><span class="">PostgreSQL</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postgrespgbench-li">
  <a href="/postgres/pgbench/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-postgrespgbench"><span class="">pgbench</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postgrespgstat_snap-li">
  <a href="/postgres/pgstat_snap/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-postgrespgstat_snap"><span class="">pgstat_snap</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-oracle-li">
  <a href="/oracle/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-oracle"><span class="">Oracle</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-oracleash-li">
  <a href="/oracle/ash/" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-oracleash"><span class="td-sidebar-nav-active-item">Active Session History</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-oracleashtop-li">
  <a href="/oracle/ashtop/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-oracleashtop"><span class="">ashtop</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-stuff-li">
  <a href="/stuff/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-stuff"><span class="">Other stuff</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-stuffstuff-li">
  <a href="/stuff/stuff/" title="other stuff" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-stuffstuff"><span class="">Other stuff</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/raphideb/raphideb.github.io/tree/main/content/oracle/ash.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/raphideb/raphideb.github.io/edit/main/content/oracle/ash.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/raphideb/raphideb.github.io/new/main/content/oracle?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/raphideb/raphideb.github.io/issues/new?title=Active%20Session%20History" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  
</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ash-basics">ASH Basics</a>
      <ul>
        <li><a href="#useful-tables-and-views">Useful Tables and Views</a></li>
        <li><a href="#description-of-the-fields">Description of the fields</a></li>
        <li><a href="#checking-available-ash-data">Checking available ASH data</a></li>
        <li><a href="#saving-ash-data">Saving ASH data</a></li>
      </ul>
    </li>
    <li><a href="#how-to-write-ash-scripts">How to write ASH scripts</a>
      <ul>
        <li><a href="#basic-script">Basic Script</a></li>
      </ul>
    </li>
    <li><a href="#drilldown">Drilldown</a>
      <ul>
        <li><a href="#finding-blocking-sessions">Finding blocking sessions</a></li>
        <li><a href="#tracing-a-specific-query">Tracing a specific query</a></li>
        <li><a href="#plsql-queries">PL/SQL queries</a></li>
        <li><a href="#viewing-specific-events">Viewing specific events</a></li>
        <li><a href="#other-useful-filters">Other useful filters</a></li>
      </ul>
    </li>
    <li><a href="#more-ash-queries">More ASH queries</a>
      <ul>
        <li><a href="#track-pga-usage">Track PGA usage</a></li>
        <li><a href="#track-temp-usage">Track TEMP usage</a></li>
      </ul>
    </li>
    <li><a href="#making-sense-of-the-output">Making sense of the output</a>
      <ul>
        <li><a href="#time_waited">TIME_WAITED</a></li>
        <li><a href="#wait-events">Wait events</a></li>
        <li><a href="#locks-and-blocking-sessions">Locks and blocking sessions</a></li>
      </ul>
    </li>
    <li><a href="#common-waits-and-what-to-do-about-them">Common waits and what to do about them</a></li>
    <li><a href="#make-your-life-easier">Make your life easier</a></li>
  </ul>
</nav>
      </div>
    
            

          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/oracle/">Oracle</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    Active Session History</li>
  </ol>
</nav>
<div class="td-content">
	<h1>Active Session History</h1>
	<div class="lead">Oracle&rsquo;s active session history demystified</div>
	<header class="article-meta">
		
<p class="reading-time"><i class="fa-solid fa-clock" aria-hidden="true"></i>&nbsp; 15 minute read &nbsp;</p>
</header>
	<img class="floatimg" src="/oracle/ash.jpg" alt="active_session_history" width="25%" height="25%"/>
<p>The view gv$active_session_history (ASH) records in memory every second the wait events of all active sessions. It is the single most important source of information for deep performance analysis on a session or even query level, like what a session was doing in a particular moment in time, what queries it was executing or which other sessions were blocking it. For all the data it contains it is surprisingly easy to use. First I will explain how the ASH works and what fields it provides, then I show you a basic script and how to extend it with all sorts of queries to get the info that you need.
<p>Since the memory for ASH is limited, the data is only available for a few days or even hours. It is also usually gone when the instance was restarted, therefore, every 10 seconds a snapshot of the ASH data is stored permanently on disk and can be accessed through the view dba_hist_active_sess_history (DASH). The live view (Top activity) of Enterprise Manager is based on ASH data, AWR reports are based on dba_hist_* views.</p></p>
<div style="clear: both;"></div>
<h2 id="ash-basics">ASH Basics</h2>
<p>All ASH/DASH data is stored at the CDB level and can be accessed either from the CDB or a specific PDB. However, when you want to map the USER_ID, CURRENT_OBJ#, CURRENT_FILE# etc to names stored in dba_views, it&rsquo;s best to query ASH from within the corresponding PDB.</p>
<p>A word about gv$active_session_history vs. v$active_session_history: While they are defacto the same on a non-RAC database, on a RAC database the v$ variant only shows sessions running on one instance, whereas gv$ shows all sessions an all instances of the database. I therefore made it a habbit to always use gv$active_session_history and include the inst_id in my queries. The same is true for many other v$ views, in RAC there&rsquo;s usually a gv$ variant (like gv$session).</p>
<p>Note that the dba_hist views are always cluster wide and store the data for all instances.</p>
<h3 id="useful-tables-and-views">Useful Tables and Views</h3>
<p>To fully leverage all the information that the ASH provides, it helps to know some other useful views related to performance analysis.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Name</th>
          <th style="text-align: left">Description</th>
          <th style="text-align: left">Notes</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">v$active_session_history</td>
          <td style="text-align: left">Wait events for all sessions of a node in 1-second snapshots</td>
          <td style="text-align: left">In memory, limited space</td>
      </tr>
      <tr>
          <td style="text-align: left">gv$active_session_history</td>
          <td style="text-align: left">Same as above, but for all nodes in a RAC cluster</td>
          <td style="text-align: left">Has additional column &ldquo;INST_ID&rdquo;</td>
      </tr>
      <tr>
          <td style="text-align: left">dba_hist_active_sess_history</td>
          <td style="text-align: left">Historical 10-second snapshots of ASH</td>
          <td style="text-align: left">Stored on disk; &ldquo;INSTANCE_NUMBER&rdquo; instead of &ldquo;INST_ID&rdquo;</td>
      </tr>
      <tr>
          <td style="text-align: left">v$ash_info</td>
          <td style="text-align: left">Statistics about ASH itself</td>
          <td style="text-align: left">&ldquo;OLDEST_SAMPLE_TIME&rdquo; shows how far back data goes</td>
      </tr>
      <tr>
          <td style="text-align: left">v$sql</td>
          <td style="text-align: left">Stats for currently loaded SQL statements</td>
          <td style="text-align: left">One row per child cursor</td>
      </tr>
      <tr>
          <td style="text-align: left">dba_hist_sqltext</td>
          <td style="text-align: left">Historical SQL text for SQL_IDs no longer in shared area</td>
          <td style="text-align: left">Use <code>set long 10000</code> to see full text</td>
      </tr>
      <tr>
          <td style="text-align: left">dba_objects</td>
          <td style="text-align: left">Info on all objects in the DB</td>
          <td style="text-align: left">Useful for mapping to current_obj# in ASH</td>
      </tr>
      <tr>
          <td style="text-align: left">dba_data_files</td>
          <td style="text-align: left">Info on all data files</td>
          <td style="text-align: left">Useful for mapping to current_file# in ASH</td>
      </tr>
  </tbody>
</table>
<h3 id="description-of-the-fields">Description of the fields</h3>
<p>ASH and DASH have over 100 fields, and more are added with each release. The description of all fields is available here:
<a href="https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/DBA_HIST_ACTIVE_SESS_HISTORY.html">https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/DBA_HIST_ACTIVE_SESS_HISTORY.html</a></p>
<h4 id="useful-fields">Useful Fields</h4>
<p>All fields of ASH/DASH can be useful in specific cases, but the following are the most commonly used:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Column</th>
          <th style="text-align: left">Datatype</th>
          <th style="text-align: left">Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">INST_ID</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Only in gv$active_session_history, RAC instance where the session is running</td>
      </tr>
      <tr>
          <td style="text-align: left">INSTANCE_NUMBER</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Only in dba_hist_active_sess_history, RAC instance where the session is running</td>
      </tr>
      <tr>
          <td style="text-align: left">SAMPLE_ID</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">ID of the sample</td>
      </tr>
      <tr>
          <td style="text-align: left">SAMPLE_TIME</td>
          <td style="text-align: left">TIMESTAMP(3)</td>
          <td style="text-align: left">Time at which the sample was taken</td>
      </tr>
      <tr>
          <td style="text-align: left">SESSION_ID</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Session identifier; maps to V$SESSION.SID</td>
      </tr>
      <tr>
          <td style="text-align: left">SESSION_SERIAL#</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Session serial number (uniquely identifies a session&rsquo;s objects); maps to V$SESSION.SERIAL#</td>
      </tr>
      <tr>
          <td style="text-align: left">SESSION_TYPE</td>
          <td style="text-align: left">VARCHAR2(10)</td>
          <td style="text-align: left">Session type: FOREGROUND/BACKGROUND</td>
      </tr>
      <tr>
          <td style="text-align: left">USER_ID</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Oracle user identifier; maps to V$SESSION.USER#</td>
      </tr>
      <tr>
          <td style="text-align: left">SQL_ID</td>
          <td style="text-align: left">VARCHAR2(13)</td>
          <td style="text-align: left">SQL identifier of the SQL statement executed at the time of sampling</td>
      </tr>
      <tr>
          <td style="text-align: left">SQL_OPNAME</td>
          <td style="text-align: left">VARCHAR2(64)</td>
          <td style="text-align: left">SQL command name (INSERT, DELETE, UPDATE, etc.)</td>
      </tr>
      <tr>
          <td style="text-align: left">TOP_LEVEL_SQL_ID</td>
          <td style="text-align: left">VARCHAR2(13)</td>
          <td style="text-align: left">SQL identifier of the top-level SQL statement (for PL/SQL)</td>
      </tr>
      <tr>
          <td style="text-align: left">SQL_PLAN_HASH_VALUE</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Numeric representation of the SQL plan for the cursor</td>
      </tr>
      <tr>
          <td style="text-align: left">EVENT</td>
          <td style="text-align: left">VARCHAR2(64)</td>
          <td style="text-align: left">If SESSION_STATE = WAITING, the event waited for; if ON CPU, this column is NULL</td>
      </tr>
      <tr>
          <td style="text-align: left">P1TEXT</td>
          <td style="text-align: left">VARCHAR2(64)</td>
          <td style="text-align: left">Text of the first additional parameter</td>
      </tr>
      <tr>
          <td style="text-align: left">P1</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">First additional parameter</td>
      </tr>
      <tr>
          <td style="text-align: left">P2TEXT</td>
          <td style="text-align: left">VARCHAR2(64)</td>
          <td style="text-align: left">Text of the second additional parameter</td>
      </tr>
      <tr>
          <td style="text-align: left">P2</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Second additional parameter</td>
      </tr>
      <tr>
          <td style="text-align: left">P3TEXT</td>
          <td style="text-align: left">VARCHAR2(64)</td>
          <td style="text-align: left">Text of the third additional parameter</td>
      </tr>
      <tr>
          <td style="text-align: left">P3</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Third additional parameter</td>
      </tr>
      <tr>
          <td style="text-align: left">WAIT_CLASS</td>
          <td style="text-align: left">VARCHAR2(64)</td>
          <td style="text-align: left">Wait class name of the event</td>
      </tr>
      <tr>
          <td style="text-align: left">SESSION_STATE</td>
          <td style="text-align: left">VARCHAR2(7)</td>
          <td style="text-align: left">Session state: WAITING / ON CPU</td>
      </tr>
      <tr>
          <td style="text-align: left">TIME_WAITED</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">If WAITING, time spent waiting for that event (in microseconds)</td>
      </tr>
      <tr>
          <td style="text-align: left">BLOCKING_SESSION</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Session ID of the blocking session</td>
      </tr>
      <tr>
          <td style="text-align: left">BLOCKING_INST_ID</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Instance number of the blocker</td>
      </tr>
      <tr>
          <td style="text-align: left">CURRENT_OBJ#</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Object ID referenced</td>
      </tr>
      <tr>
          <td style="text-align: left">CURRENT_FILE#</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">File number referenced</td>
      </tr>
      <tr>
          <td style="text-align: left">CURRENT_BLOCK#</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Block ID referenced</td>
      </tr>
      <tr>
          <td style="text-align: left">REMOTE_INSTANCE#</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Remote instance serving the block</td>
      </tr>
      <tr>
          <td style="text-align: left">PGA_ALLOCATED</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">PGA memory used (in bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">TEMP_SPACE_ALLOCATED</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">TEMP memory used (in bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">CON_DBID</td>
          <td style="text-align: left">NUMBER</td>
          <td style="text-align: left">Database ID of the pluggable database (PDB)</td>
      </tr>
      <tr>
          <td style="text-align: left">PROGRAM</td>
          <td style="text-align: left">VARCHAR2(48)</td>
          <td style="text-align: left">Name of the operating system program</td>
      </tr>
      <tr>
          <td style="text-align: left">MACHINE</td>
          <td style="text-align: left">VARCHAR2(64)</td>
          <td style="text-align: left">Client&rsquo;s operating system machine name</td>
      </tr>
  </tbody>
</table>
<p><strong>Good to Know:</strong></p>
<ul>
<li>Wait events that only affect the CDB, such as backup activities, are not shown when querying ASH in the PDB.</li>
<li>A session in the PDB can have a blocking session from the CDB, e.g., the logwriter session. The wait events of the blocking session itself must then be analyzed via the CDB.</li>
</ul>
<h3 id="checking-available-ash-data">Checking available ASH data</h3>
<p>Before analyzing a problem in the ASH, you should ensure that the data for the relevant period is still available:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">oldest_sample_time</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">gv$ash_info</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- output
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">OLDEST_SAMPLE_TIME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">03</span><span class="o">-</span><span class="n">SEP</span><span class="o">-</span><span class="mi">21</span><span class="w"> </span><span class="mi">03</span><span class="p">.</span><span class="mi">34</span><span class="p">.</span><span class="mi">03</span><span class="p">.</span><span class="mi">575000000</span><span class="w"> </span><span class="n">AM</span><span class="w">
</span></span></span></code></pre></div><p>Query information before &ldquo;OLDEST_SAMPLE_TIME&rdquo; can only be viewed via DASH.</p>
<h3 id="saving-ash-data">Saving ASH data</h3>
<p>If you want to analyze the problem later, it is advisable to save the entire ASH to a table to not lose the data in it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">ash_snapshot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">gv$active_session_history</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>In scripts, you should then select from this table instead:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- from gv$active_session_history
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">from</span><span class="w"> </span><span class="n">ash_snapshot</span><span class="w">
</span></span></span></code></pre></div><p><strong>Good to Know:</strong>
Queries that are no longer in ASH and ran less than 10 seconds may not appear in DASH either. In such cases, the waits of a query can no longer be meaningfully analyzed.</p>
<h2 id="how-to-write-ash-scripts">How to write ASH scripts</h2>
<p>As you will shortly see, it&rsquo;s very easy to start with a basic script to get an overview and then drill deeper to find the root cause of a particular problem. Even when you use scripts like Tanel Poder&rsquo;s &ldquo;ashtop&rdquo; it&rsquo;s good to have a basic understanding of how to query the ASH and get the maximum out of those scripts. I&rsquo;ll also show the difference between queries from ASH or DASH.</p>
<h3 id="basic-script">Basic Script</h3>
<p>Let&rsquo;s start with a basic query which will be the blueprint for our more complex queries. It returns the most important columns of all wait events in the last hour for all nodes of a RAC database and works in both CDB and PDB.</p>
<h4 id="query-from-ash">Query from ASH</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">set</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="mi">400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="mi">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a22</span><span class="w"> </span><span class="n">tru</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a30</span><span class="w"> </span><span class="n">tru</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">sample_time</span><span class="p">,</span><span class="w"> </span><span class="n">inst_id</span><span class="p">,</span><span class="w"> </span><span class="n">sql_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">time_waited</span><span class="p">,</span><span class="w"> </span><span class="n">current_obj</span><span class="o">#</span><span class="p">,</span><span class="w"> </span><span class="n">blocking_session</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">gv$active_session_history</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sample_time</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h4 id="query-from-dash">Query from DASH</h4>
<p>Difference from the ASH version:</p>
<ul>
<li>instance_number instead of inst_id</li>
<li>dba_hist_active_sess_history instead of gv$active_session_history</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">set</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="mi">400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="mi">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a22</span><span class="w"> </span><span class="n">tru</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a30</span><span class="w"> </span><span class="n">tru</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">sample_time</span><span class="p">,</span><span class="w"> </span><span class="n">instance_number</span><span class="p">,</span><span class="w"> </span><span class="n">sql_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">time_waited</span><span class="p">,</span><span class="w"> </span><span class="n">current_obj</span><span class="o">#</span><span class="p">,</span><span class="w"> </span><span class="n">blocking_session</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">dba_hist_active_sess_history</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sample_time</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p><strong>Sample Output:</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">SAMPLE_TIME</th>
          <th style="text-align: left">INST_ID</th>
          <th style="text-align: left">SQL_ID</th>
          <th style="text-align: left">SESSION_ID</th>
          <th style="text-align: left">USER_ID</th>
          <th style="text-align: left">EVENT</th>
          <th style="text-align: left">TIME_WAITED</th>
          <th style="text-align: left">CURRENT_OBJ#</th>
          <th style="text-align: left">BLOCKING_SESSION</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">08-JUL-25 03.40.44.241</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">b913hx8hf360t</td>
          <td style="text-align: left">5059</td>
          <td style="text-align: left">89</td>
          <td style="text-align: left">direct path read</td>
          <td style="text-align: left">3764</td>
          <td style="text-align: left">45305959</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.41.07.142</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">di8yqa8tfsgqu</td>
          <td style="text-align: left">2312</td>
          <td style="text-align: left">89</td>
          <td style="text-align: left">cursor: pin S wait on X</td>
          <td style="text-align: left">234920</td>
          <td style="text-align: left">4463384</td>
          <td style="text-align: left">4801</td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.41.07.142</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">cy6kjxcbcz8p3</td>
          <td style="text-align: left">893</td>
          <td style="text-align: left">89</td>
          <td style="text-align: left">db file parallel read</td>
          <td style="text-align: left">3275</td>
          <td style="text-align: left">48367311</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.41.07.142</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">di8yqa8tfsgqu</td>
          <td style="text-align: left">17769</td>
          <td style="text-align: left">89</td>
          <td style="text-align: left">cursor: pin S wait on X</td>
          <td style="text-align: left">274117</td>
          <td style="text-align: left">4463382</td>
          <td style="text-align: left">4801</td>
      </tr>
  </tbody>
</table>
<h4 id="mapping-to-user-and-object-name">Mapping to User and Object Name</h4>
<p>The user and object names can be joined to have names instead of ids, but only in the PDB:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">set</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="mi">400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="mi">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a22</span><span class="w"> </span><span class="n">tru</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a30</span><span class="w"> </span><span class="n">tru</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">object_name</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">sample_time</span><span class="p">,</span><span class="w"> </span><span class="n">inst_id</span><span class="p">,</span><span class="w"> </span><span class="n">sql_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">time_waited</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">object_name</span><span class="p">,</span><span class="w"> </span><span class="n">blocking_session</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">gv$active_session_history</span><span class="w"> </span><span class="n">a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">join</span><span class="w"> </span><span class="n">dba_users</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">join</span><span class="w"> </span><span class="n">dba_objects</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">current_obj</span><span class="o">#</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">object_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p><strong>Sample Output:</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">SAMPLE_TIME</th>
          <th style="text-align: left">INST_ID</th>
          <th style="text-align: left">SQL_ID</th>
          <th style="text-align: left">SESSION_ID</th>
          <th style="text-align: left">USERNAME</th>
          <th style="text-align: left">EVENT</th>
          <th style="text-align: left">TIME_WAITED</th>
          <th style="text-align: left">OBJECT_NAME</th>
          <th style="text-align: left">BLOCKING_SESSION</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">08-JUL-25 03.40.54.854</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">84p8c9j3ctpua</td>
          <td style="text-align: left">14553</td>
          <td style="text-align: left">RAPHI_USER</td>
          <td style="text-align: left">cursor: pin S wait on X</td>
          <td style="text-align: left">1191291</td>
          <td style="text-align: left">TRACKING_TABLE</td>
          <td style="text-align: left">11326</td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.40.54.854</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">84p8c9j3ctpua</td>
          <td style="text-align: left">9272</td>
          <td style="text-align: left">RAPHI_USER</td>
          <td style="text-align: left">cursor: pin S wait on X</td>
          <td style="text-align: left">1206884</td>
          <td style="text-align: left">TRK_PK_IDX</td>
          <td style="text-align: left">11326</td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.42.08.156</td>
          <td style="text-align: left">3</td>
          <td style="text-align: left">cxfgr5c2j9zgg</td>
          <td style="text-align: left">7578</td>
          <td style="text-align: left">RAPHI_USER</td>
          <td style="text-align: left">row cache lock</td>
          <td style="text-align: left">5642933</td>
          <td style="text-align: left">SUB_PART_MGR</td>
          <td style="text-align: left">4975</td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.42.08.156</td>
          <td style="text-align: left">3</td>
          <td style="text-align: left">bz77a36407aty</td>
          <td style="text-align: left">4622</td>
          <td style="text-align: left">RAPHI_USER</td>
          <td style="text-align: left">row cache lock</td>
          <td style="text-align: left">5650066</td>
          <td style="text-align: left">SUB_PART_MGR</td>
          <td style="text-align: left">4975</td>
      </tr>
  </tbody>
</table>
<p>Now we are getting somewhere, we see the username and which objects where affected by the wait clearly.</p>
<h4 id="limiting-the-time-range">Limiting the time range</h4>
<p>The &ldquo;sample_time&rdquo; column can be used to limit the query period, allowing you to focus on the relevant part. This can be done relative to sysdate:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span></code></pre></div><p>or as a specific time range:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;25-Nov-2020 00:40:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;DD-Mon-YYYY HH24:MI:SS&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;25-Nov-2020 00:50:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;DD-Mon-YYYY HH24:MI:SS&#39;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>or both combined:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;25-Nov-2020 00:40:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;DD-Mon-YYYY HH24:MI:SS&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h4 id="limiting-the-number-of-rows">Limiting the number of rows</h4>
<p>In one hour, ASH can record a huge number of rows, but often only the last 100 are of interest. To focus only on them, reverse the sort order and limit the output with fetch:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">desc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fetch</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">only</span><span class="w">
</span></span></span></code></pre></div><h2 id="drilldown">Drilldown</h2>
<p>With the basic script, you can get an overview of what was happening in the database during the selected period. The script can then be extended as needed to further narrow down the problem.</p>
<h3 id="finding-blocking-sessions">Finding blocking sessions</h3>
<p>If, for example, a blocking_session is responsible for many waits, you can look at this session in more detail  the number in the &ldquo;blocking_session&rdquo; column is the session_id of the blocking session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123456</span><span class="w">
</span></span></span></code></pre></div><h3 id="tracing-a-specific-query">Tracing a specific query</h3>
<p>Similarly, if you want to look at a specific query, just filter by sql_id:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="n">sql_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1ps650r41s7qr&#39;</span><span class="w">
</span></span></span></code></pre></div><h3 id="plsql-queries">PL/SQL queries</h3>
<p>In Oracle Enterprise Manager, you often only see the SQL_ID of the PL/SQL procedure among the top sessions. If you want to view all associated queries, filter by top_level_sql_id and specify the PL/SQL sql_id:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="n">top_level_sql_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1ps650r41s7qr&#39;</span><span class="w">
</span></span></span></code></pre></div><h3 id="viewing-specific-events">Viewing specific events</h3>
<p>You can easily identify sessions affected by a specific wait using the Event column. A list of all possible wait events can be obtained with this query:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">wait_class</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">V$EVENT_NAME</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>Alternatively, you can list only the waits that actually occur in ASH:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">gv$active_session_history</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>To filter for specific event types, extend the basic query, for example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- pick one of these:
</span></span></span><span class="line"><span class="cl"><span class="c1">-- index contention
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">and</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;enq: TX - index contention&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- all transaction contentions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">and</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;enq: TX%&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- read/write operations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;db file%&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;direct path%&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- all cluster waits (full RAC)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">and</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;gc%&#39;</span><span class="w">
</span></span></span></code></pre></div><h3 id="other-useful-filters">Other useful filters</h3>
<ul>
<li>Waits over 1 second:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">and</span><span class="w"> </span><span class="n">time_waited</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000000</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>Sessions accessing a specific object:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">and</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">object_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;NAME_OF_OBJECT&#39;</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>Sessions accessing a specific file:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">and</span><span class="w"> </span><span class="n">current_file</span><span class="o">#</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">134</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>Sessions accessing the same block in the same file (e.g., in case of contention):</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">and</span><span class="w"> </span><span class="n">current_file</span><span class="o">#</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">134</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="n">current_block</span><span class="o">#</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123456</span><span class="w">
</span></span></span></code></pre></div><h2 id="more-ash-queries">More ASH queries</h2>
<p>Some other ASH queries which are not directly developed from the basic script above but can also be useful.</p>
<h3 id="track-pga-usage">Track PGA usage</h3>
<p>With this query, you can check how much PGA each session_id has used:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">inst_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_serial</span><span class="o">#</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">pga_allocated</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="w"> </span><span class="n">GB</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">gv$active_session_history</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">inst_id</span><span class="p">,</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_serial</span><span class="o">#</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="track-temp-usage">Track TEMP usage</h3>
<p>Similarly, you can find the sessions that have used the most TEMP:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">inst_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_serial</span><span class="o">#</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">temp_space_allocated</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="w"> </span><span class="n">GB</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">gv$active_session_history</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">inst_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_serial</span><span class="o">#</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h2 id="making-sense-of-the-output">Making sense of the output</h2>
<p>Now that we know how to query the ASH it&rsquo;s time to speak about what to do with the information.</p>
<h3 id="time_waited">TIME_WAITED</h3>
<p>As mentioned above, ASH data is stored every second for all sessions. The &ldquo;TIME_WAITED&rdquo; column shows 0 when a session was still waiting for a particular event to end when it was added to ASH. When ordered by sample_time, the first non-zero value for a unique combination of inst_id/session_id/sql_id shows the total amount of time (in ms) the session had to wait on that event. When the &ldquo;TIME_WAITED&rdquo; and &ldquo;EVENT&rdquo; column are NULL (not 0) on the other hand, the session was on the CPU and not waiting for an event. You can select the session_state in your query if you want to confirm this.</p>
<p>In this example, session 14553 was waiting for &ldquo;cursor: pin S wait on X&rdquo; since 3:40:54 for 4120324 microseconds, when it finally finished at 3:40:58. Session 7578 was running on the CPU and thus did not have any wait event.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">SAMPLE_TIME</th>
          <th style="text-align: left">INST_ID</th>
          <th style="text-align: left">SQL_ID</th>
          <th style="text-align: left">SESSION_ID</th>
          <th style="text-align: left">EVENT</th>
          <th style="text-align: left">TIME_WAITED</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">08-JUL-25 03.40.54.154</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">84p8c9j3ctpua</td>
          <td style="text-align: left">14553</td>
          <td style="text-align: left">cursor: pin S wait on X</td>
          <td style="text-align: left">0</td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.40.55.134</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">84p8c9j3ctpua</td>
          <td style="text-align: left">14553</td>
          <td style="text-align: left">cursor: pin S wait on X</td>
          <td style="text-align: left">0</td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.40.56.112</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">84p8c9j3ctpua</td>
          <td style="text-align: left">14553</td>
          <td style="text-align: left">cursor: pin S wait on X</td>
          <td style="text-align: left">0</td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.40.57.252</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">84p8c9j3ctpua</td>
          <td style="text-align: left">14553</td>
          <td style="text-align: left">cursor: pin S wait on X</td>
          <td style="text-align: left">4120324</td>
      </tr>
      <tr>
          <td style="text-align: left">08-JUL-25 03.40.58.252</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">cxfgr5c2j9zgg</td>
          <td style="text-align: left">7578</td>
          <td style="text-align: left"></td>
          <td style="text-align: left"></td>
      </tr>
  </tbody>
</table>
<h3 id="wait-events">Wait events</h3>
<p>This is the true bread and butter of the ASH. Understanding wait events, why they occur, what impact they have, how to correlate them and ultimately how to solve them is what makes performance tuning an art form rather than a scientific method. I can not go into the details of every important wait event because most would warrant a dedicated blog post of it&rsquo;s own. However, the official Oracle documentation has a brief description of all wait events:</p>
<p><a href="https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/descriptions-of-wait-events.html">https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/descriptions-of-wait-events.html</a></p>
<p>A good way to start when someone tells you that the database was slow, without any particulars like a sql_id or session_id, is to look for any events with a time_waited higher than a second. If one wait event stands out, check the documentation or google it. AI like perplexity.ai are also very good at explaining certain wait events, but it helps if you have at least some understanding because especially with everything Oracle, AI tends to blatantly lie to your face (apparently because the Oracle documentation is unclear, as perplexity explained to me :D).</p>
<h4 id="event-parameters">Event Parameters</h4>
<p>When searching for wait events, it&rsquo;s often useful to select the &ldquo;P1&rdquo; column (and possibly P2, P3). These provide additional information about the wait event, e.g. for Row Cache Locks, which DC Cache was involved. The columns &ldquo;P1TEXT&rdquo; (and P2TEXT, P3TEXT) give a descriptive name to the value. To see what the individual P-values mean, you can look at v$event_name:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">set</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="mi">400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">col</span><span class="w"> </span><span class="n">parameter1</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">col</span><span class="w"> </span><span class="n">parameter2</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">col</span><span class="w"> </span><span class="n">parameter3</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">parameter1</span><span class="p">,</span><span class="w"> </span><span class="n">parameter2</span><span class="p">,</span><span class="w"> </span><span class="n">parameter3</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">V$EVENT_NAME</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;row%lock&#39;</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p><strong>Sample Output:</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">NAME</th>
          <th style="text-align: left">PARAMETER1</th>
          <th style="text-align: left">PARAMETER2</th>
          <th style="text-align: left">PARAMETER3</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">row cache lock</td>
          <td style="text-align: left">cache id</td>
          <td style="text-align: left">mode</td>
          <td style="text-align: left">request</td>
      </tr>
  </tbody>
</table>
<p>You can then extend the basic query accordingly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">set</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="mi">400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="mi">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a22</span><span class="w"> </span><span class="n">tru</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">column</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">a30</span><span class="w"> </span><span class="n">tru</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">sample_time</span><span class="p">,</span><span class="w"> </span><span class="n">inst_id</span><span class="p">,</span><span class="w"> </span><span class="n">sql_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">p1text</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">time_waited</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">gv$active_session_history</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">sample_time</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sysdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;row%lock&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="locks-and-blocking-sessions">Locks and blocking sessions</h3>
<p>One of the most common reason for a sudden performance loss is the application itself accessing the database. This can have a very <del>stupid</del>simple cause, like someone manually executed a query that was updating a column of all rows in a table while the application was running, resulting in tons of row locks.</p>
<p>Other less obvious causes are normal application sessions running slower than usual, causing locks and blocking other sessions. Possible causes from my own experience:</p>
<ul>
<li>execution plan of a query has suddenly changed for whatever reason, like missing statistics or different bind values</li>
<li>a network problem between the application and DB server</li>
<li>a network problem in a dataguard environment with MaxProtection between primary and standby</li>
<li>accessing the same table on different instances in a RAC database, causing a lot of block shipping</li>
<li>not enough SGA to handle increased application volume, resulting in more blocks read from disk</li>
<li>not enough PGA to handle complex queries, resulting in more temp usage</li>
<li>Oracle changing the default for the parameter db_lost_write_protection in 19.26c (this caused us real headache)</li>
<li>and many more</li>
</ul>
<p>Not all of these issues can be resolved with ASH alone but you most likely will find out where to look. For example, if you see a blocking session appearing in many other sessions, check what that session was doing:</p>
<ul>
<li>what queries was it running</li>
<li>what objects was it accessing</li>
<li>what wait events did it spend the most time on</li>
<li>was it also blocked by yet another session</li>
</ul>
<p>The examples in the drill down section above should help you closing in on the source of the problem.</p>
<h2 id="common-waits-and-what-to-do-about-them">Common waits and what to do about them</h2>
<p>This is an attempt of a cookie-cutter guide for some of the more common wait events.</p>
<table><tr><th>Symptom</th><th>Reasons</th><th>Actions</th></tr>
<tr><td><ul><li>Many logfile sync events with high time_waited (> 1000000)</li></ul></td>
<td><ul><li>overload of the database, too many sessions</li>
<li>network issues in dataguard</li>
<li>SAN/storage problems</li>
<li>high CPU usage</li></ul></td>
<td><ul><li>Check average active sessions are lower than nr of cpu cores</li>
<li>Check alert.log for many logswitches or remote sync timeouts</li>
<li>Check /var/log/messages and cluster logs (if using grid) for any link down errors</li>
<li>Check if SAN and network load is below it's limits</li>
<li>Check host cpu usage with "top" or "sar"</li></ul>
<tr><td><ul><li>High amount of enq: xxx  or lock wait events</li></ul></td>
<td><ul><li>Contention of some sorts:</li>
<li>enq: TX - transaction related (locks on same object)</li>
<li>enq: SN/SQ - sequences related </li>
<li>enq: IV or L[A-P] - library cache related</li>
<li>row cache lock - DDL related</li></ul></td>
<td><ul><li>Check for blocking sessions and current_obj#</li>
<li>Increase the sequence cache</li>
<li>Check for too many parses or parallel sessions - or bugs</li>
<li>Check for DDL on current_obj#, can also occur when a segment is being extended or any other dictionary operation affecting an object</li></ul>
</td></tr>
<tr><td><ul><li>High amount of gc: xxx wait evens</li></ul></td>
<td><ul><li>RAC related, usually different instances accessing the same objects</li></ul></td>
<td><ul><li>Check for similar queries running on different "INST_ID"</li>
<li>Check for different "INST_ID" accessing the same current_obj#</li>
<li>Ensure that Jumbo Frames are enabled on the interconnect</li>
<li>Use instance bound services to separate the workload and table access</li></ul></td></tr>
</table>
<h2 id="make-your-life-easier">Make your life easier</h2>
<p>Now that you hopefully have a better understanding of how to work with the active session history, it&rsquo;s time to let you in on a secret: Tanel Poder&rsquo;s script &ldquo;ashtop.sql&rdquo; does all the heavy lifting for us and in most cases it is no longer needed to write a custom script ourselfs. The basic script in this post can replaced with this ashtop.sql query:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">@</span><span class="n">ashtop</span><span class="w"> </span><span class="n">inst_id</span><span class="p">,</span><span class="n">session_id</span><span class="p">,</span><span class="n">sql_id</span><span class="p">,</span><span class="k">user</span><span class="p">,</span><span class="n">objt</span><span class="p">,</span><span class="n">event2</span><span class="p">,</span><span class="n">time_waited</span><span class="p">,</span><span class="n">blocking_session</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">sysdate</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>Or to just get an overview of the top queries:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">@</span><span class="n">ashtop</span><span class="w"> </span><span class="n">sql_id</span><span class="p">,</span><span class="n">event2</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">sysdate</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">sysdate</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>Bear in mind though that it only shows the top 15 queries, which makes it even more important that you know what to query and be as specific as you can.</p>
<p>I am a big fan of ashtop.sql and use it on a daily basis. I explain it in detail with more drill down examples here: <a href="/oracle/ashtop">/oracle/ashtop</a></p>

	
<div class="text-muted pt-3 border-top">
  Last modified: July 9, 2025
</div>


</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        
      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.js"></script>
<script defer src="/js/click-to-copy.js" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>